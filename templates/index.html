{% extends "base.html" %}
{% block title %}Nuevo Mapa - GeoExcel Map{% endblock %}
{% block content %}
<div class="row">
  <div class="col-lg-4">
    <h3>Crear Nuevo Mapa</h3>
    <p class="text-muted">Sube tu archivo Excel y configura la visualización.</p>
    <form action="{{ url_for('generate_map_step1') }}" method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="excel_file" class="form-label">Archivo Excel (.xlsx)</label>
            <input class="form-control" type="file" id="excel_file" name="excel_file" required accept=".xlsx,.xls">
            <div class="form-text"><a href="{{ url_for('download_sample') }}">Descargar archivo de ejemplo</a></div>
        </div>
        <div class="mb-3">
            <label for="map_type" class="form-label">Tipo de Mapa</label>
            <select class="form-select" id="map_type" name="map_type">
                <option value="points" {% if form_data and form_data.map_type == 'points' %}selected{% endif %}>Puntos Agrupados</option>
                <option value="heatmap" {% if form_data and form_data.map_type == 'heatmap' %}selected{% endif %}>Mapa de Calor</option>
            </select>
        </div>
        <div id="heatmap-options" class="mb-3 p-3 border rounded {% if not form_data or form_data.map_type != 'heatmap' %}d-none{% endif %}">
            <h5>Opciones de Mapa de Calor</h5>
            <label for="radius" class="form-label">Radio</label>
            <input type="range" class="form-range" id="radius" name="radius" min="5" max="50" value="{{ form_data.radius if form_data else 15 }}">
        </div>
        <button type="submit" class="btn btn-primary w-100">Generar Mapa</button>
    </form>
  </div>
  <div class="col-lg-8">
    <div class="card" style="height: 75vh;">
        <div class="card-header d-flex justify-content-between align-items-center">
            Vista Previa
            {% if map_url %}
            <form action="{{ url_for('save_project') }}" method="post" class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" name="project_name" placeholder="Nombre del Proyecto" required>
                <button type="submit" class="btn btn-success btn-sm flex-shrink-0">Guardar</button>
            </form>
            {% endif %}
        </div>
        <div class="card-body p-0">
            {% if map_url %}
                <!-- CAMBIO CLAVE: Usamos src en lugar de srcdoc -->
                <iframe src="{{ map_url }}" width="100%" height="100%" frameborder="0"></iframe>
            {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted"><p>El mapa aparecerá aquí.</p></div>
            {% endif %}
        </div>
    </div>
  </div>
</div>
<script>
    document.getElementById('map_type').addEventListener('change', (e) => {
        document.getElementById('heatmap-options').classList.toggle('d-none', e.target.value !== 'heatmap');
    });
</script>
{% endblock %}